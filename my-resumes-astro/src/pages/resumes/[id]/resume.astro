---
import FormSubmit from "../../../components/FormSubmit.astro";
import ResumeLayout from "../../../components/layout/ResumeLayout.astro";
import TextInput from "../../../components/TextInput.astro";
import { ResumePdf } from "../../../components/react/ResumePdf";
import { z } from "astro/zod";

const { id } = Astro.params;

let error = "";

const resume = {
  title: "Lorem ipsum dolor",
  description:
    "Lorem ipsum dolor sit amet consectetur, adipisicing elit. Accusamus numquam corrupti sunt consequuntur a quaerat voluptates, quasi perspiciatis deserunt aliquid labore nulla cumque minus. Inventore, error. Sunt veritatis minima quibusdam?",
};

if (Astro.request.method === "POST") {
  const schema = z.object({
    title: z
      .string({ invalid_type_error: "Invalid title" })
      .min(1, "Title must have at least 1 character"),
    description: z.string({ invalid_type_error: "Invalid description" }),
  });

  const formData = Object.fromEntries(
    (await Astro.request.formData()).entries()
  );

  const payload = schema.safeParse(formData);

  if (payload.success) {
    console.log("save", payload.data);
    resume.title = payload.data.title;
    resume.description = payload.data.description;

    return Astro.redirect(`/resumes/${id}/profile`);
  } else {
    error = payload.error.errors[0]?.message ?? "Invalid data";
  }
}
---

<ResumeLayout>
  <div class="flex space-x-4">
    <form class="w-80 form-card" method="post">
      <TextInput
        label="Title"
        value={resume.title}
        name="title"
        required
        placeholder="Title"
      />
      <TextInput
        label="Description"
        value={resume.description}
        name="description"
        placeholder="Description"
        area={true}
      />

      <FormSubmit error={error} />
    </form>
    <div class="w-80 form-card">
      <ResumePdf client:load />
    </div>
  </div>
</ResumeLayout>
