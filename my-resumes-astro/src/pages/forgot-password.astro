---
import { z } from "astro/zod";
import { TextInput } from "../components/common/TextInput";
import MainLayout from "../layout/MainLayout.astro";
import { backend } from "../services/backend";

let error = "";
let email = "";
let linkSent = false;

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const entries = Object.fromEntries(formData.entries());

  email = formData.get("email")?.toString() || "";

  const schema = z.object({
    email: z
      .string({ required_error: "Email is required" })
      .email("Invalid email"),
  });

  const payload = schema.safeParse(entries);

  if (payload.success) {
    try {
      await backend.requestPasswordReset(payload.data.email);
      linkSent = true;
    } catch (error) {
      console.error(error);
      error = "Something went wrong. Please try again later.";
    }
  } else {
    error = payload.error.issues[0].message;
  }
}
---

<MainLayout>
  <div class="flex-1 flex items-center justify-center">
    <form class="space-y-4" method="POST">
      <div class="text-lg font-semibold text-center">Forgot Password</div>
      <div class="text-sm text-center mb-4">
        Type your email below and we'll send<br /> you a link to reset your
        password.
      </div>

      <TextInput
        label="E-mail"
        name="email"
        type="email"
        value={email}
        placeholder="Enter your email"
        required
      />

      <div class="text-error text-sm my-2">{error}</div>
      <button type="submit" class="btn btn-primary btn-wide">Send</button>
    </form>

    {
      linkSent && (
        <dialog
          id="sentDialog"
          class="bg-white shadow-lg rounded px-8 py-4 space-y-4"
        >
          <p class="text-center">We sent you an email.</p>
          <p class="text-center">
            Open your email and click on the link to reset your password.
          </p>
          <form class="flex justify-end" method="dialog">
            <button class="btn btn-primary btn-sm">Close</button>
          </form>
        </dialog>
      )
    }

    <script>
      const dialog = document.getElementById("sentDialog");
      console.log(dialog);
      if (dialog) {
        (dialog as HTMLDialogElement).showModal();
      }
    </script>
  </div>
</MainLayout>
